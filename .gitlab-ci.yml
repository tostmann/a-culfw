image: python:3.9

variables:
  # Caching-Pfade definieren
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PLATFORMIO_CACHE_DIR: "$CI_PROJECT_DIR/.cache/platformio"
  PLATFORMIO_CORE_DIR: "$CI_PROJECT_DIR/.cache/platformio"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip
    - .cache/platformio

stages:
  - build

build_firmware:
  stage: build
  before_script:
    - pip install -U platformio
  script:
    - echo "Wechsle in das Projektverzeichnis..."
    # WICHTIG: Erst in den Unterordner wechseln!
    - cd culfw
    - echo "Starte Build Prozess..."
    - pio run
    - echo "Build abgeschlossen. Suche Hex-Dateien..."
    # Optional: Zur Kontrolle auflisten
    - ls -R Devices | grep ".hex"
  artifacts:
    name: "culfw-build-$CI_PIPELINE_IID"
    paths:
      # WICHTIG: Der Pfad muss vom Git-Root aus angegeben werden!
      # Also inklusive "culfw/" Pr√§fix.
      - culfw/Devices/**/*.hex
    expire_in: 4 weeks
